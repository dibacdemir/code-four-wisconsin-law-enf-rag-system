<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wisconsin Legal Chat – Code Four</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #121212;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #0a0a0a;
            border-bottom: 1px solid #222222;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header .badge {
            background: #005cde;
            color: white;
            font-size: 0.75rem;
            padding: 2px 10px;
            border-radius: 9999px;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Quick access buttons */
        .quick-access {
            background: #0a0a0a;
            border-bottom: 1px solid #222222;
            padding: 12px 24px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: transparent;
            border: 1px solid #333333;
            color: #d1d5db;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            border-color: #005cde;
            color: #ffffff;
            transform: scale(1.02);
        }

        /* Chat area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 80%;
            animation: fadeIn 0.5s ease-out;
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background: #005cde;
            color: white;
        }

        .message.assistant .message-bubble {
            background: #0a0a0a;
            border: 1px solid #222222;
            color: #d1d5db;
        }

        .message-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .message.user .message-label {
            text-align: right;
        }

        /* Sources */
        .sources {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #222222;
        }

        .sources-title {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .source-tag {
            display: inline-block;
            background: #1a1a2e;
            border: 1px solid #333333;
            color: #d1d5db;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 4px;
            margin: 2px 4px 2px 0;
        }

        /* Loading animation */
        .loading-dots {
            display: flex;
            gap: 6px;
            padding: 14px 18px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #005cde;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input area */
        .input-area {
            background: #0a0a0a;
            border-top: 1px solid #222222;
            padding: 16px 24px;
            display: flex;
            gap: 12px;
        }

        .input-area input {
            flex: 1;
            background: #121212;
            border: 1px solid #333333;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-area input:focus {
            border-color: #005cde;
            box-shadow: 0 0 0 2px rgba(0, 92, 222, 0.2);
        }

        .input-area input::placeholder {
            color: #666;
        }

        .send-btn {
            background: #005cde;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: #2563eb;
            transform: scale(1.02);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Disclaimer banner */
        .disclaimer {
            background: #1a1a0a;
            border-bottom: 1px solid #333300;
            padding: 8px 24px;
            font-size: 12px;
            color: #eab308;
            text-align: center;
        }

        /* Markdown-like formatting in responses */
        .message-bubble strong {
            color: #ffffff;
            font-weight: 600;
        }

        .message-bubble p {
            margin-bottom: 8px;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .message { max-width: 95%; }
            .quick-access { padding: 8px 12px; }
            .input-area { padding: 12px; }
            .chat-area { padding: 12px; }
        }
    </style>
</head>
<body>

     <div class="header">
        <h1>Wisconsin Legal Chat</h1>
        <span class="badge">RAG System</span>
        <button class="export-btn" onclick="exportConversation()" style="margin-left:auto; background:transparent; border:1px solid #333333; color:#d1d5db; padding:6px 16px; border-radius:4px; font-size:13px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.borderColor='#005cde';this.style.color='#fff'" onmouseout="this.style.borderColor='#333333';this.style.color='#d1d5db'">Export Report</button>
        <button onclick="localStorage.removeItem('wi_legal_chat_history'); chatArea.innerHTML=''" style="margin-left:8px; background:transparent; border:1px solid #333333; color:#d1d5db; padding:6px 16px; border-radius:4px; font-size:13px; cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.borderColor='#ef4444';this.style.color='#fff'" onmouseout="this.style.borderColor='#333333';this.style.color='#d1d5db'">Clear</button>

    </div>

    <div class="disclaimer">
        ⚠ This system provides legal information only, not legal advice. Always consult legal counsel for specific situations.
    </div>

    <div class="quick-access">
        <button class="quick-btn" onclick="askQuestion('What Miranda warnings are required for juveniles?')">Miranda – Juveniles</button>
        <button class="quick-btn" onclick="askQuestion('Can I search a vehicle during a traffic stop without consent?')">Vehicle Search</button>
        <button class="quick-btn" onclick="askQuestion('What are the elements required for OWI 3rd offense in Wisconsin?')">OWI 3rd Offense</button>
        <button class="quick-btn" onclick="askQuestion('What is the statute of limitations for misdemeanor theft?')">Theft – Statute of Limitations</button>
        <button class="quick-btn" onclick="askQuestion('Show me recent cases about Terry stops in Wisconsin')">Terry Stops</button>
    </div>

    <div class="chat-area" id="chatArea">
        <!-- Messages appear here -->
    </div>

    <div class="input-area">
        <input
            type="text"
            id="queryInput"
            placeholder="Ask a legal question..."
            onkeydown="if(event.key === 'Enter') sendQuery()"
        />
        <button class="send-btn" id="sendBtn" onclick="sendQuery()">Send</button>
    </div>

    <script>
        const API_URL = "http://localhost:8000";
        const chatArea = document.getElementById("chatArea");
        const queryInput = document.getElementById("queryInput");
        const sendBtn = document.getElementById("sendBtn");

        function askQuestion(question) {
            queryInput.value = question;
            sendQuery();
        }

        async function sendQuery() {
            const question = queryInput.value.trim();
            if (!question) return;

            // Disable input while loading
            queryInput.disabled = true;
            sendBtn.disabled = true;

            // Add user message
            addMessage(question, "user");
            queryInput.value = "";

            // Show loading
            const loadingEl = addLoading();

            try {
                const response = await fetch(`${API_URL}/query`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question }),
                });

                const data = await response.json();

                // Remove loading
                loadingEl.remove();

                // Add assistant message with sources
                addMessage(data.answer, "assistant", data.sources, data.confidence);

            } catch (error) {
                loadingEl.remove();
                addMessage("Error: Could not connect to the server. Make sure the API is running.", "assistant");
            }

            // Re-enable input
            queryInput.disabled = false;
            sendBtn.disabled = false;
            queryInput.focus();
        }

        function addMessage(text, role, sources = [], confidence = null) {

            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${role}`;

            const label = document.createElement("div");
            label.className = "message-label";
            label.textContent = role === "user" ? "You" : "Legal Assistant";

            const bubble = document.createElement("div");
            bubble.className = "message-bubble";

            // Basic markdown-like formatting
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\n\n/g, "</p><p>")
                .replace(/\n/g, "<br>");
            bubble.innerHTML = `<p>${formatted}</p>`;

            messageDiv.appendChild(label);
            messageDiv.appendChild(bubble);

                        // Add confidence + sources if available
            if (sources && sources.length > 0) {
                const sourcesDiv = document.createElement("div");
                sourcesDiv.className = "sources";

                const metaLine = document.createElement("div");
                metaLine.style.cssText = "display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;";
                metaLine.innerHTML = `<div class="sources-title">Sources</div>`;

                if (typeof confidence === "number") {
                    const pct = Math.round(confidence * 100);
                    const color = pct >= 75 ? "#00B96B" : pct >= 50 ? "#F4801A" : "#ef4444";
                    metaLine.innerHTML += `<span style="font-size:11px; font-weight:600; color:${color}; text-transform:uppercase;">Confidence ${pct}%</span>`;
                }

                sourcesDiv.appendChild(metaLine);

                sources.forEach(source => {
                    const tag = document.createElement("span");
                    tag.className = "source-tag";
                    if (source.doc_type === "statute") {
                        tag.textContent = `§ ${source.section_number} (${source.source_file})`;
                    } else {
                        tag.textContent = `${source.source_file} (${source.doc_type})`;
                    }
                    sourcesDiv.appendChild(tag);
                });

                messageDiv.appendChild(sourcesDiv);
            }


            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            saveHistory()
            return messageDiv;
        }

        function addLoading() {
            const messageDiv = document.createElement("div");
            messageDiv.className = "message assistant";

            const label = document.createElement("div");
            label.className = "message-label";
            label.textContent = "Legal Assistant";

            const dots = document.createElement("div");
            dots.className = "loading-dots";
            dots.innerHTML = "<span></span><span></span><span></span>";

            messageDiv.appendChild(label);
            messageDiv.appendChild(dots);

            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;

            return messageDiv;
        }
        
        function exportConversation() {
            const messages = chatArea.querySelectorAll(".message");
            if (messages.length === 0) {
                alert("No conversation to export yet.");
                return;
            }

            let report = "WISCONSIN LEGAL CHAT — EXPORTED REPORT\n";
            report += "Generated: " + new Date().toLocaleString() + "\n";
            report += "=".repeat(60) + "\n\n";

            messages.forEach(msg => {
                const isUser = msg.classList.contains("user");
                const bubble = msg.querySelector(".message-bubble");
                const sourcesEl = msg.querySelector(".sources");

                if (isUser) {
                    report += "OFFICER QUERY:\n" + bubble.innerText.trim() + "\n\n";
                } else {
                    report += "LEGAL ASSISTANT:\n" + bubble.innerText.trim() + "\n";
                    if (sourcesEl) {
                        report += "\nSOURCES: " + sourcesEl.innerText.replace(/\n/g, " | ").trim() + "\n";
                    }
                    report += "\n" + "-".repeat(60) + "\n\n";
                }
            });

            const blob = new Blob([report], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `legal-chat-export-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

            function saveHistory() {
            const messages = [];
            chatArea.querySelectorAll(".message").forEach(msg => {
                messages.push({
                    role: msg.classList.contains("user") ? "user" : "assistant",
                    html: msg.innerHTML,
                });
            });
            try {
                localStorage.setItem("wi_legal_chat_history", JSON.stringify(messages));
            } catch (e) {
                // localStorage full or unavailable — silently skip
            }
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem("wi_legal_chat_history");
                if (!saved) return;
                const messages = JSON.parse(saved);
                messages.forEach(({ role, html }) => {
                    const div = document.createElement("div");
                    div.className = `message ${role}`;
                    div.innerHTML = html;
                    chatArea.appendChild(div);
                });
                chatArea.scrollTop = chatArea.scrollHeight;
            } catch (e) {
                localStorage.removeItem("wi_legal_chat_history");
            }
        }

        // Load history on page open
        loadHistory();

   
    </script>

</body>
</html>